name: BedolagaBot

on:
  push:
    branches:
      - main
      - dev
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0  

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Get version info
      id: version
      run: |
        echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        
        echo "build_date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
        
        # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¸ Ñ‚ÐµÐ³Ð¸
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
          TAGS="fr1ngg/remnawave-bedolaga-telegram-bot:latest,fr1ngg/remnawave-bedolaga-telegram-bot:${VERSION}"
          echo "ðŸ·ï¸ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ñ€ÐµÐ»Ð¸Ð·Ð½ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ: $VERSION"
        elif [[ $GITHUB_REF == refs/heads/main ]]; then
          VERSION="v2.4.6-$(git rev-parse --short HEAD)"
          TAGS="fr1ngg/remnawave-bedolaga-telegram-bot:latest,fr1ngg/remnawave-bedolaga-telegram-bot:${VERSION}"
          echo "ðŸš€ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¸Ð· main: $VERSION"
        elif [[ $GITHUB_REF == refs/heads/dev ]]; then
          VERSION="v2.4.6-dev-$(git rev-parse --short HEAD)"
          TAGS="fr1ngg/remnawave-bedolaga-telegram-bot:dev,fr1ngg/remnawave-bedolaga-telegram-bot:${VERSION}"
          echo "ðŸ§ª Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ dev Ð²ÐµÑ€ÑÐ¸ÑŽ: $VERSION"
        else
          VERSION="v2.4.6-pr-$(git rev-parse --short HEAD)"
          TAGS="fr1ngg/remnawave-bedolaga-telegram-bot:pr-$(git rev-parse --short HEAD)"
          echo "ðŸ”€ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ PR Ð²ÐµÑ€ÑÐ¸ÑŽ: $VERSION"
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tags=$TAGS" >> $GITHUB_OUTPUT
        echo "should_push=${{ github.event_name != 'pull_request' }}" >> $GITHUB_OUTPUT
        
        echo "=== Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÑÐ±Ð¾Ñ€ÐºÐµ ==="
        echo "Ð’ÐµÑ€ÑÐ¸Ñ: $VERSION"
        echo "ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚: $(git rev-parse --short HEAD)"
        echo "Ð¢ÐµÐ³Ð¸: $TAGS"
        echo "Push: ${{ github.event_name != 'pull_request' }}"
        echo "==========================="

    - name: Login to Docker Hub
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/amd64,linux/arm64
        push: ${{ steps.version.outputs.should_push }}
        tags: ${{ steps.version.outputs.tags }}
        build-args: |
          VERSION=${{ steps.version.outputs.version }}
          BUILD_DATE=${{ steps.version.outputs.build_date }}
          VCS_REF=${{ steps.version.outputs.short_sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        labels: |
          org.opencontainers.image.version=${{ steps.version.outputs.version }}
          org.opencontainers.image.created=${{ steps.version.outputs.build_date }}
          org.opencontainers.image.revision=${{ steps.version.outputs.short_sha }}
          org.opencontainers.image.title=Bedolaga RemnaWave Bot
          org.opencontainers.image.description=Telegram bot for RemnaWave VPN service
          org.opencontainers.image.source=https://github.com/${{ github.repository }}

    - name: Build Summary
      if: github.event_name != 'pull_request'
      run: |
        echo "## ðŸš€ Docker Hub Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "| ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€ | Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|----------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Ð’ÐµÑ€ÑÐ¸Ñ** | \`${{ steps.version.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚** | \`${{ steps.version.outputs.short_sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Ð”Ð°Ñ‚Ð° ÑÐ±Ð¾Ñ€ÐºÐ¸** | \`${{ steps.version.outputs.build_date }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Registry** | Docker Hub |" >> $GITHUB_STEP_SUMMARY
        echo "| **Ð’ÐµÑ‚ÐºÐ°** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Ð¡Ñ‚Ð°Ñ‚ÑƒÑ** | âœ… ÐžÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½ |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ ÐžÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ñ‚ÐµÐ³Ð¸:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.version.outputs.tags }}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Ð¡ÑÑ‹Ð»ÐºÐ¸:" >> $GITHUB_STEP_SUMMARY
        echo "- [Docker Hub Repository](https://hub.docker.com/r/fr1ngg/remnawave-bedolaga-telegram-bot)" >> $GITHUB_STEP_SUMMARY
